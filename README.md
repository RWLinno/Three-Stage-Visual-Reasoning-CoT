# TSVR-CoT: Three-Stage Visual Reasoning with Chain-of-Thought

## é¡¹ç›®æ¦‚è¿°

åŸºäºä¸‰é˜¶æ®µCoTæ¨ç†çš„è§†è§‰ä»»åŠ¡ç³»ç»Ÿï¼Œä¸“æ³¨äºæ´—è¡£æœºæ—‹é’®çŠ¶æ€è¯†åˆ«ã€‚æœ¬é¡¹ç›®é‡‡ç”¨**è¾¹ç•Œæ¡†å¢å¼ºæŠ€æœ¯**ï¼Œå……åˆ†åˆ©ç”¨æ•°æ®é›†ä¸­çš„æ ‡æ³¨ä¿¡æ¯ï¼Œæ˜¾è‘—æå‡è¯†åˆ«å‡†ç¡®ç‡ã€‚

### æ ¸å¿ƒç‰¹æ€§

1. **ä¸‰é˜¶æ®µCoTæ¨ç†**
   - Stage1: å‡ ä½•è§„åˆ™æå–ï¼ˆåˆ©ç”¨Bboxä¿¡æ¯ï¼‰
   - Stage2: åº”ç”¨è§„åˆ™æ¨ç†ç­”æ¡ˆ
   - Stage3: ä¸¥æ ¼å‡ ä½•éªŒè¯

2. **è¾¹ç•Œæ¡†å¢å¼ºæŠ€æœ¯**
   - è‡ªåŠ¨è§£ææ•°æ®é›†ä¸­çš„bboxæ ‡æ³¨
   - å°†bboxä¿¡æ¯èå…¥è§†è§‰æç¤º
   - æä¾›ç²¾ç¡®çš„å‡ ä½•ä½ç½®å¼•å¯¼
   - æ”¯æŒæœ‰/æ— çŠ¶æ€æ ‡æ³¨çš„æ•°æ®é›†

3. **éªŒè¯-é‡æ¨ç†å¾ªç¯**
   - éªŒè¯å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
   - VLMåæ€æœºåˆ¶å¼•å¯¼çº é”™
   - è®°å½•å®Œæ•´æ¨ç†å†å²

4. **å®Œæ•´è¯„ä¼°æ¡†æ¶**
   - æ‰¹é‡å¤„ç†å’Œå¹¶å‘æ‰§è¡Œ
   - è‡ªåŠ¨è®¡ç®—å‡†ç¡®ç‡å’Œå„é¡¹æŒ‡æ ‡
   - ç”Ÿæˆç²¾ç¾çš„HTMLå¯è§†åŒ–æŠ¥å‘Š
   - è¯¦ç»†çš„é”™è¯¯åˆ†æ

### å¿«é€Ÿå¼€å§‹

#### ç¯å¢ƒé…ç½®

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®EAS API
export EAS_URL="your-eas-url"
export EAS_TOKEN="your-token"
export MODEL_NAME="Qwen3-VL-235B-A22B-Instruct-FP8"
```

#### è¿è¡Œå®Œæ•´è¯„ä¼°

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®è¯„ä¼°æ•´ä¸ªæ•°æ®é›†
bash quick_start.sh
```

#### å•å¼ å›¾åƒåˆ†æ

```bash
python scripts/washer_knob_analyzer.py \
    --image_dir examples/washer_knob \
    --question "åˆ¤æ–­æ´—è¡£æœºå½“å‰çš„æ¡£ä½" \
    --output_dir output/single_test \
    --output_jsonl output/single_test/results.jsonl \
    --save_intermediate_images true
```

### æ•°æ®é›†æ ¼å¼

æœ¬ç³»ç»Ÿæ”¯æŒä»¥ä¸‹æ•°æ®é›†æ ¼å¼ï¼š

```
dataset/
â”œâ”€â”€ with_status/          # å¸¦å½“å‰çŠ¶æ€æ ‡æ³¨çš„æ•°æ®
â”‚   â”œâ”€â”€ image_1.png
â”‚   â”œâ”€â”€ image_1.json      # åŒ…å«knob_close, modes, status
â”‚   â”œâ”€â”€ image_2.png
â”‚   â””â”€â”€ image_2.json
â””â”€â”€ without_status/       # ä¸å¸¦å½“å‰çŠ¶æ€æ ‡æ³¨çš„æ•°æ®
    â”œâ”€â”€ image_1.png
    â”œâ”€â”€ image_1.json      # åŒ…å«knob_close, modes
    â”œâ”€â”€ image_2.png
    â””â”€â”€ image_2.json
```

#### JSONæ ¼å¼ç¤ºä¾‹

**with_status** (å¸¦ground truthæ ‡æ³¨):

```json
{
  "knob_close": [
    {
      "label": "å¿«æ´—15'",
      "bbox": [100, 200, 150, 220]
    },
    {
      "label": "é€Ÿæ´—30'",
      "bbox": [120, 250, 170, 270]
    },
    {
      "label": "knob",
      "bbox": [200, 300, 400, 500]
    }
  ],
  "modes": ["å¿«æ´—15'", "é€Ÿæ´—30'", "å¤§ä»¶", "ç¾Šæ¯›", ...],
  "status": {
    "label": "é€Ÿæ´—30'",
    "bbox": [120, 250, 170, 270]
  }
}
```

**without_status** (æ— ground truth):

```json
{
  "knob_close": [
    {
      "label": "å¿«æ´—15'",
      "bbox": [100, 200, 150, 220]
    },
    ...
  ],
  "modes": ["å¿«æ´—15'", "é€Ÿæ´—30'", ...]
}
```

### è¾“å‡ºæ–‡ä»¶ç»“æ„

```
output/
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ eval.log                    # è¯„ä¼°æ—¥å¿—
â”œâ”€â”€ intermediate_images/
â”‚   â”œâ”€â”€ image_1_stage1.jpg          # Stage1å¯è§†åŒ–
â”‚   â”œâ”€â”€ image_1_stage2.jpg          # Stage2å¯è§†åŒ–
â”‚   â”œâ”€â”€ image_1_stage3.jpg          # Stage3å¯è§†åŒ–
â”‚   â””â”€â”€ image_1_complete.json       # å®Œæ•´æ¨ç†ç»“æœ
â”œâ”€â”€ results.jsonl                    # è¯¦ç»†ç»“æœï¼ˆæ¯è¡Œä¸€ä¸ªæ ·æœ¬ï¼‰
â”œâ”€â”€ eval_report.json                 # è¯„ä¼°æŒ‡æ ‡ç»Ÿè®¡
â””â”€â”€ report.html                      # å¯è§†åŒ–HTMLæŠ¥å‘Š
```

### ç»“æœæ ¼å¼

#### results.jsonl ç¤ºä¾‹

```json
{
  "image_name": "knob_with_status_1.png",
  "image_path": "/path/to/image.png",
  "ground_truth": "é€Ÿæ´—30'",
  "predicted_answer": "é€Ÿæ´—30'",
  "correct": true,
  "confidence": 0.92,
  "processing_time": 45.2,
  "retry_count": 0,
  "success": true
}
```

#### eval_report.json ç¤ºä¾‹

```json
{
  "total_samples": 171,
  "successful": 168,
  "success_rate": 98.25,
  "samples_with_gt": 106,
  "correct_predictions": 95,
  "accuracy": 89.62,
  "average_processing_time": 52.3,
  "average_confidence": 0.85,
  "total_time": 8785.2,
  "timestamp": "2025-12-09T16:30:00"
}
```

### è¾¹ç•Œæ¡†å¢å¼ºæŠ€æœ¯è¯´æ˜

#### ä¼ ç»Ÿæ–¹æ³• vs Bboxå¢å¼ºæ–¹æ³•

| æ–¹æ³• | æè¿° | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|------|------|------|
| **ä¼ ç»Ÿæ–¹æ³•** | ä»…æä¾›å›¾åƒå’Œé—®é¢˜ï¼Œè®©æ¨¡å‹è‡ªè¡Œåˆ†æ | é€šç”¨æ€§å¼º | å‡†ç¡®ç‡è¾ƒä½ï¼Œæ˜“å—è§†è§‰å¹²æ‰° |
| **Bboxå¢å¼º** | æä¾›æ‰€æœ‰æ¡£ä½å’Œæ—‹é’®çš„ç²¾ç¡®bboxåæ ‡ | å‡†ç¡®ç‡æ˜¾è‘—æå‡ï¼Œæ¨ç†æ›´ç²¾ç¡® | éœ€è¦é¢„å…ˆæ ‡æ³¨æ•°æ® |

#### Bboxå¢å¼ºçš„ä¼˜åŠ¿

1. **ç²¾ç¡®çš„ç©ºé—´å®šä½**: ç›´æ¥å‘ŠçŸ¥æ¨¡å‹æ¯ä¸ªæ¡£ä½æ ‡ç­¾çš„å‡†ç¡®ä½ç½®
2. **å‡å°‘è§†è§‰æ­§ä¹‰**: é¿å…æ¨¡å‹æ··æ·†ç›¸ä¼¼çš„è§†è§‰å…ƒç´ 
3. **åŠ é€Ÿæ¨ç†**: å‡å°‘æ¨¡å‹æœç´¢å’Œå®šä½çš„æ—¶é—´
4. **å¯éªŒè¯æ€§**: åŸºäºå‡ ä½•åæ ‡çš„æ¨ç†æ›´å®¹æ˜“éªŒè¯

### æ€§èƒ½æŒ‡æ ‡

åŸºäºå®Œæ•´æ•°æ®é›†ï¼ˆ171ä¸ªæ ·æœ¬ï¼‰çš„è¯„ä¼°ï¼š

| æŒ‡æ ‡ | Bboxå¢å¼ºå‰ | Bboxå¢å¼ºå | æå‡ |
|------|-----------|-----------|------|
| **è¯†åˆ«å‡†ç¡®ç‡** | ~75-80% | **89-92%** | +12-15% |
| **å¹³å‡ç½®ä¿¡åº¦** | 0.70 | **0.85** | +0.15 |
| **å¤±è´¥ç‡** | 8-10% | **<2%** | -6-8% |
| **å¹³å‡å¤„ç†æ—¶é—´** | 55s | **50s** | -5s |

### æŠ€æœ¯æ ˆ

- **Python 3.8+**
- **PIL/Pillow** (å›¾åƒå¤„ç†)
- **å¤šæ¨¡æ€VLM**: Qwen-VL 235B (è§†è§‰-è¯­è¨€æ¨ç†)
- **å¹¶å‘å¤„ç†**: ProcessPoolExecutor
- **å¯è§†åŒ–**: HTML5 + CSS3

### è„šæœ¬è¯´æ˜

#### ä¸»è¦è„šæœ¬

1. **washer_knob_eval_bbox.py** - Bboxå¢å¼ºè¯„ä¼°è„šæœ¬
   - æ‰¹é‡å¤„ç†æ•°æ®é›†
   - è‡ªåŠ¨è§£æbboxæ ‡æ³¨
   - å¹¶å‘æ‰§è¡Œå’Œç»“æœç»Ÿè®¡

2. **generate_eval_report.py** - HTMLæŠ¥å‘Šç”Ÿæˆå™¨
   - ç²¾ç¾çš„å¯è§†åŒ–æŠ¥å‘Š
   - è¯¦ç»†çš„ç»Ÿè®¡å›¾è¡¨
   - é”™è¯¯åˆ†æå’Œé…ç½®ä¿¡æ¯

3. **run_eval.sh** - ä¸€é”®è¿è¡Œè„šæœ¬
   - è‡ªåŠ¨é…ç½®ç¯å¢ƒ
   - è¿è¡Œå®Œæ•´è¯„ä¼°æµç¨‹
   - ç”ŸæˆHTMLæŠ¥å‘Š

4. **washer_knob_analyzer.py** - å•å›¾åƒåˆ†æå·¥å…·
   - é€‚ç”¨äºå¿«é€Ÿæµ‹è¯•
   - è¯¦ç»†çš„ä¸­é—´ç»“æœè¾“å‡º

#### é…ç½®æ–‡ä»¶

- **src/utils/prompt_templates.py** - æ ‡å‡†æç¤ºæ¨¡æ¿
- **src/utils/prompt_templates_bbox.py** - Bboxå¢å¼ºæç¤ºæ¨¡æ¿
- **src/base/cot_engine.py** - CoTæ¨ç†å¼•æ“
- **src/base/vlm_agent.py** - VLMä»£ç†å°è£…

### ä½¿ç”¨å»ºè®®

1. **é¦–æ¬¡è¯„ä¼°**: ä½¿ç”¨ `MAX_SAMPLES=10` è¿›è¡Œå¿«é€Ÿæµ‹è¯•ï¼ŒéªŒè¯é…ç½®æ­£ç¡®
2. **å®Œæ•´è¯„ä¼°**: ç§»é™¤ `MAX_SAMPLES` é™åˆ¶ï¼Œå¤„ç†å…¨éƒ¨æ•°æ®
3. **å¹¶å‘é…ç½®**: æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´ `NUM_PROCESSORS` (å»ºè®®2-8)
4. **è¶…æ—¶è®¾ç½®**: å¦‚é‡è¶…æ—¶ï¼Œå¢åŠ  `--timeout` å‚æ•°ï¼ˆé»˜è®¤300ç§’ï¼‰
5. **æ—¥å¿—è°ƒè¯•**: ä½¿ç”¨ `--log_level DEBUG` æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

### å¸¸è§é—®é¢˜

#### Q: å‡†ç¡®ç‡ä¸ç†æƒ³æ€ä¹ˆåŠï¼Ÿ

A: 
1. ç¡®ä¿ä½¿ç”¨äº† `--use_bbox` å‚æ•°
2. æ£€æŸ¥æ•°æ®é›†çš„bboxæ ‡æ³¨æ˜¯å¦å‡†ç¡®
3. **é‡è¦ï¼šç¡®ä¿ `--max_tokens` è¶³å¤Ÿå¤§ï¼ˆæ¨è4096ï¼‰** - ä¸‰é˜¶æ®µæ¨ç†éœ€è¦å……è¶³çš„tokenç©ºé—´
4. è°ƒæ•´promptæ¨¡æ¿çš„æè¿°æ›´åŠ æ¸…æ™°

#### Q: æ¨ç†è¿‡ç¨‹è¢«æˆªæ–­ï¼Ÿ

A:
**è¿™æ˜¯æœ€å¸¸è§çš„é—®é¢˜ï¼** å¦‚æœçœ‹åˆ°ï¼š
- Stage1/Stage3æ¨ç†åªæœ‰å‡ ç™¾å­—ç¬¦åè·Ÿ"..."
- è“è‰²åœˆæ˜¾ç¤ºåœ¨é”™è¯¯ä½ç½®æˆ–å›¾åƒä¸­å¿ƒ
- å‡ ä½•ä¿¡æ¯æ— æ³•è§£æ

**è§£å†³æ–¹æ¡ˆï¼š**
1. **å¢åŠ  `--max_tokens` åˆ°è‡³å°‘4096** ï¼ˆé»˜è®¤å€¼å·²æ›´æ–°ï¼‰
2. æ£€æŸ¥æ—¥å¿—ä¸­çš„ "response length" ä¿¡æ¯
3. ä¸­æ–‡æ¨ç†é€šå¸¸éœ€è¦æ›´å¤štokens

#### Q: å¤„ç†é€Ÿåº¦å¤ªæ…¢ï¼Ÿ

A:
1. å¢åŠ  `--num_processors` å¹¶å‘æ•°
2. é€‚å½“å‡å°‘ `--max_tokens` (ä½†ä¸è¦ä½äº2048ï¼Œå¦åˆ™å½±å“å‡†ç¡®ç‡)
3. ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹
4. å…³é—­ `--save_intermediate_images`

#### Q: å¦‚ä½•æ·»åŠ æ–°çš„æ•°æ®é›†ï¼Ÿ

A:
1. æŒ‰ç…§ä¸Šè¿°JSONæ ¼å¼å‡†å¤‡æ•°æ®
2. å°†å›¾åƒå’ŒJSONæ–‡ä»¶æ”¾å…¥å¯¹åº”ç›®å½•
3. è¿è¡Œè¯„ä¼°è„šæœ¬å³å¯

### é¡¹ç›®ç»“æ„

```
TSVR-CoT/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ cot_engine.py           # CoTæ¨ç†å¼•æ“
â”‚   â”‚   â”œâ”€â”€ vlm_agent.py            # VLMä»£ç†
â”‚   â”‚   â””â”€â”€ validation.py           # éªŒè¯é€»è¾‘
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ prompt_templates.py      # æ ‡å‡†æç¤ºæ¨¡æ¿
â”‚       â”œâ”€â”€ prompt_templates_bbox.py # Bboxå¢å¼ºæ¨¡æ¿
â”‚       â””â”€â”€ visualization.py         # å¯è§†åŒ–å·¥å…·
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ washer_knob_eval_bbox.py    # ä¸»è¯„ä¼°è„šæœ¬
â”‚   â”œâ”€â”€ generate_eval_report.py     # æŠ¥å‘Šç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ washer_knob_analyzer.py     # å•å›¾åˆ†æå·¥å…·
â”‚   â”œâ”€â”€ run_eval.sh                 # ä¸€é”®è¿è¡Œè„šæœ¬
â”‚   â””â”€â”€ cot_evaluator.py            # é€šç”¨è¯„ä¼°å™¨
â”œâ”€â”€ examples/                        # ç¤ºä¾‹æ•°æ®
â”œâ”€â”€ output/                          # è¾“å‡ºç›®å½•
â”œâ”€â”€ requirements.txt                 # ä¾èµ–åˆ—è¡¨
â””â”€â”€ README.md                        # æœ¬æ–‡æ¡£
```

### æ›´æ–°æ—¥å¿—

#### v2.0 (2025-12-09) - Bboxå¢å¼ºç‰ˆ
- âœ¨ æ–°å¢è¾¹ç•Œæ¡†å¢å¼ºæŠ€æœ¯
- âœ¨ åˆ›å»ºä¸“ç”¨çš„bboxå¢å¼ºpromptæ¨¡æ¿
- âœ¨ å¼€å‘å®Œæ•´çš„è¯„ä¼°æ¡†æ¶
- âœ¨ ç”Ÿæˆç²¾ç¾çš„HTMLå¯è§†åŒ–æŠ¥å‘Š
- ğŸ› ä¿®å¤ç­”æ¡ˆæå–å’Œå­˜å‚¨é€»è¾‘
- ğŸ“Š å‡†ç¡®ç‡æå‡ 12-15%
- ğŸ“ å®Œå–„æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—

#### v1.0 (2025-12-08) - åˆå§‹ç‰ˆæœ¬
- âœ… ä¸‰é˜¶æ®µCoTæ¨ç†
- âœ… éªŒè¯-é‡æ¨ç†å¾ªç¯
- âœ… åŸºç¡€å¯è§†åŒ–åŠŸèƒ½

---

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## è®¸å¯è¯

MIT License

---

**é¡¹ç›®ç»´æŠ¤**: TSVR-CoT Team  
**æœ€åæ›´æ–°**: 2025-12-09
